
  | eval body=create_map(
    "activity_id", 1,
    "analytic_stories", [{%- for story in detection.tags.analytic_story %}"{{story}}"{% if not loop.last %}, {% endif %}{%- endfor -%}],
    "cis_csc", [{%- for cis in detection.tags.cis20 %}create_map("control", "{{cis}}", "version", 7){% if not loop.last %}, {% endif %}{%- endfor -%}],
    "category_uid", 2,
    "class", "Detection Report",
    "class_uid", 102001,
    "confidence", {{ detection.tags.confidence }},
    "confidence_id", {{ detection.tags.confidence_id }},
    "devices", [
        create_map(
            "uid", device_uuid, "type_id", 0)
    ],
    "duration", 0,
    "time", timestamp,
    "evidence", create_map(
        "actor.process.file.name", parent_process_name,
        "process.file.name", process_name,
        "process.cmd_line", cmd_line
    ),
    "impact", {{ detection.tags.impact }},
    "impact_id", {{ detection.tags.impact_id }},
    "kill_chain", [{%- for kill_chain_phase in detection.tags.kill_chain_phases %}create_map("phase", "{{kill_chain_phase}}", "phase_id", {{detection.tags.kill_chain_phases_id[kill_chain_phase]}}){% if not loop.last %}, {% endif %}{%- endfor -%}],
    "attacks", [{%- for enrichment in detection.tags.mitre_attack_enrichments %}create_map("tactics", [{%- for tactic in enrichment.mitre_attack_tactics %}create_map("name", "{{tactic}}", "uid", "{{attack_tactics_id_mapping[tactic|replace(" ", "_")]}}"){% if not loop.last %}, {% endif %}{%- endfor -%}], "technique", create_map("name", "{{ enrichment.mitre_attack_technique }}", "uid", "{{ enrichment.mitre_attack_id }}"), "version", "12.1"){% if not loop.last %}, {% endif %}{%- endfor -%}],  
    "message", "tbd",
    "metadata", create_map(
        "product", create_map(
            "name", "Behavioral Analytic Service",
            "vendor_name", "Splunk"
        ),
        "version", "1.0.0"
    ),
    "nist", [{%- for nist in detection.tags.nist %}"{{nist}}"{% if not loop.last %}, {% endif %}{%- endfor -%}],
    "observables", {{ detection.tags.observable_str }},
    "risk_level", "{{ detection.tags.risk_level }}",
    "risk_level_id", {{ detection.tags.risk_level_id }},
    "risk_score", {{ detection.tags.risk_score }},
    "severity_id", {{ detection.tags.impact_id }},
    "type_id", 10200101,
    "users", [
        create_map(
            "uid", inferred_caller_user_uid
        )
    ]
  )
  | into write_ba_finding_events();