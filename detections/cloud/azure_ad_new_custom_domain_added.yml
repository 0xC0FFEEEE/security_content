name: Azure AD New Custom Domain Added
id: 30c47f45-dd6a-4720-9963-0bca6c8686ef
version: 1
date: '2022-09-02'
author: Mauricio Velazco, Splunk
type: TTP
datamodel: []
description: The following analytic identifies the addition of a new custom domain within an Azure Active Directory tenant. Adding a custom domain
  is a step required to set up the Azure Active Directory identity federation backdoor technique discovered by security researcher Nestori Syynimaa. An adversary who has obtained
  privileged access to an Azure AD tenant may leverage this technique to establish persistence and be able to access Azure AD resources impersonating any user.
search: ' `azuread` body.operationName="Add unverified domain" "body.properties.result"=success
  | rename body.properties.* as *
  | rename body.callerIpAddress as callerIpAddress
  | rename initiatedBy.user.userPrincipalName as initiatedBy
  | rename targetResources{}.displayName as domain
  | stats values(domain) by _time, initiatedBy, result, body.operationName, callerIpAddress
  | `azure_ad_new_custom_domain_added_filter`'
how_to_implement: You must install the latest version of Splunk Add-on for Microsoft Cloud Services from Splunkbase (https://splunkbase.splunk.com/app/3110/#/details). You must be ingesting Azure Active Directory events into your Splunk environment. 
  Specifically, this analytic leverages the AuditLogs log category.
known_false_positives: In most organizations, new customm domains will be updated infrequently. Filter as needed. 
references:
- https://docs.microsoft.com/en-us/azure/active-directory/enterprise-users/domains-manage
- https://www.mandiant.com/resources/blog/remediation-and-hardening-strategies-for-microsoft-365-to-defend-against-unc2452
- https://o365blog.com/post/federation-vulnerability/
- https://www.inversecos.com/2021/11/how-to-detect-azure-active-directory.html
- https://www.mandiant.com/resources/blog/detecting-microsoft-365-azure-active-directory-backdoors
- https://attack.mitre.org/techniques/T1484/002/
tags:
  analytic_story:
  - Azure Active Directory Persistence
  asset_type: Azure Active Directory
  cis20:
  - CIS 3
  - CIS 5
  - CIS 16
  confidence: 90
  context:
  - Source:Cloud Data
  - Stage:Persistence
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1484.002/new_federated_domain/azure-audit.log
  impact: 60
  kill_chain_phases:
  - Installation
  - Actions on Objectives
  message: A new custom domain, $domain$ , was added by $initiatedBy$
  mitre_attack_id:
  - T1484
  - T1484.002
  nist:
  - DE.CM
  observable:
  - name: initiatedBy
    type: User
    role:
    - Attacker
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - body.operationName
  - body.properties.result
  - body.callerIpAddress
  - body.properties.targetResources{}.displayName
  - body.properties.initiatedBy.user.userPrincipalName
  risk_score: 54
  security_domain: threat
