name: AWS Excessive List Command Usage
id: d1767712-9650-11eb-a8e6-acde48001122
version: 1
date: '2021-04-05'
author: Michael Haag, Splunk
type: batch
datamodel: []
description: The following detection identifies distict list commands ran against
  the AWS environment over a 1 hour period of time. The idea is that, if a AWS key
  is lost/stolen, the adversary will begin to perform many list-* queries against
  the environment to gather further information about the account.
search: '`cloudtrail` (command = List*) user_type=IAMUser (userAgent!=*.amazonaws.com)
  | bucket _time span=1h | stats count min(_time) as firstTime max(_time) as lastTime
  , dc(command) as distinct_command_count,values(errorCode) as errorCode values(eventSource)
  as eventSource values(command) as command values(userAgent) as userAgent by src_ip,
  userName, _time | where count >= 10 and distinct_command_count > 1 | `security_content_ctime(firstTime)`
  | `security_content_ctime(lastTime)` | `aws_excessive_list_command_usage_filter`'
how_to_implement: The Splunk AWS Add-on and Splunk App for AWS is required to utilize
  this data. The search requires AWS Cloudtrail logs.
known_false_positives: It is possible ther ewill be false positives based on the count
  numbers used. Tune accordingly based on IP or user associated. From there, tune
  the values to set an upper limit for your environment.
references:
- https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListObjectsV2.html
tags:
  analytic_story:
  - AWS IAM Privilege Escalation
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1580/aws_iam_excessive_list_command_usage/aws_iam_excessive_list_command_usage.json
  kill_chain_phases:
  - Reconnaissance
  mitre_attack_id:
  - T1580
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  - Splunk Security Analytics for AWS
  required_fields:
  - _time
  - eventName
  - errorCode
  - command
  - eventSource
  - userAgent
  security_domain: access
  automated_detection_testing: passed
