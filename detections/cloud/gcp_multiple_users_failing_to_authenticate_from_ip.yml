name: GCP Multiple Users Failing To Authenticate From Ip
id: da20828e-d6fb-4ee5-afb7-d0ac200923d5
version: 1
date: '2022-10-12'
author: Bhavin Patel, Splunk
type: Anomaly
datamodel:
- Endpoint
description: The following analytic identifies one source Ip failing to authenticate into the Google Workspace user accounts with 20 unique valid users within 10 minutes. These user accounts may have other privileges with respect to access to other sensitive resources in the Google Cloud Platform. This behavior could represent an adversary performing a Password Spraying attack against an Google Workspace environment to obtain initial access or elevate privileges. 
search: "`gws_reports_login` authentication_method IN ( "google_password", "password, password", "password" ) event.type = "login" event.name = "login_failure" | bucket span=5m _time | stats count dc(user) AS unique_accounts values(user) as tried_accounts earliest(_time) as firstTime latest(_time) as lastTime by _time authentication_method event.name src app id.applicationName | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` |  where unique_accounts > 20 | `gcp_multiple_users_failing_to_authenticate_from_ip_filter`"

how_to_implement:  Please install the Splunk Add-on for Google Workspace from Splunkbase(https://splunkbase.splunk.com/app/5556),  which allows a Splunk administrator to collect Google Workspace event data using Google Workspace APIs in Splunk. These detections are based on user log events like authentication, password change, 2FA enrollment from the Google audit reports which are ingested into Splunk in `sourcetype=gws:reports:login`. Find more details about this dataset- https://support.google.com/a/answer/4580120?hl=en&ref_topic=9027054. We would also recommend tuning the detection by adjusting the window `span` and `unique_accounts` threshold values according to your environment. s
known_false_positives: No known false postives for this detection. Please review this alert!
references:
- https://cloud.google.com/blog/products/identity-security/how-google-cloud-can-help-stop-credential-stuffing-attacks
references:
- https://attack.mitre.org/techniques/T1110/003/
- https://www.whiteoaksecurity.com/blog/goawsconsolespray-password-spraying-tool/
- https://softwaresecuritydotblog.wordpress.com/2019/09/28/how-to-protect-against-credential-stuffing-on-aws/
tags:
  analytic_story:
  -  -----
  asset_type: AWS Account
  cis20:
  - CIS 3
  - CIS 5
  - CIS 16
  confidence: 90
  context:
  - Source:Cloud Data
  - Outcome:Blocked
  - Stage:Recon
  - Other:Brute Force
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1110.003/gcp_gws_multiple_login_failure/gws_login.json
  impact: 60
  kill_chain_phases:
  - Exploitation
  message: Multiple failed login attempts against users $tried_accounts$ seen from $src_ip$
  mitre_attack_id:
  - T1110.003
  nist:
  - DE.CM
  observable:
  - name: src
    type: IP Address
    role:
    - Attacker
  - name: tried_accounts
    type: User
    role:
    - Victim
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - user
  - action
  - eventName
  - src_ip
  risk_score: 54
  security_domain: threat
