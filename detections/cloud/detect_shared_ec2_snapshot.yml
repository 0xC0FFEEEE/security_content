name: Detect shared ec2 snapshot
id: 2a9b80d3-6340-4345-b5ad-290bf3d222c4
version: 2
date: '2021-07-20'
author: Bhavin Patel, Splunk
type: batch
datamodel: []
description: This search looks for AWS CloudTrail events an EC2 snapshot is shared with a different AWS account
search: '`cloudtrail` eventName=ModifySnapshotAttribute | rename requestParameters.createVolumePermission.add.items{}.userId as requested_account_id | search requested_account_id != NULL
| eval match=if(requested_account_id==aws_account_id,"Match","No Match") 
| table _time user_arn src_ip requestParameters.attributeType requested_account_id aws_account_id match vendor_region user_agent | where match = "No Match"
  | `detect_shared_ec2_snapshot_filter` '
how_to_implement: You must install splunk AWS add on and Splunk App for AWS. This
  search works with AWS CloudTrail logs.
known_false_positives: While this search has no known false positives, it is possible
  that an AWS admin has legitimately created a public bucket for a specific purpose.
  That said, AWS strongly advises against granting full control to the "All Users"
  group.
references: 
  - https://labs.nettitude.com/blog/how-to-exfiltrate-aws-ec2-data/
tags:
  analytic_story:
  - Suspicious Cloud Instance Activities
  - Data Exfiltration
  asset_type: EC2 Snapshot
  cis20:
  - CIS 13
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1530/aws_s3_public_bucket/aws_cloudtrail_events.json
  kill_chain_phases:
  - Actions on Objectives
  mitre_attack_id:
  - T1537
  nist:
  - PR.DS
  - PR.AC
  - DE.CM
  product:
  - Splunk Security Analytics for AWS
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - eventName
  - user_arn
  - src_ip
  - requestParameters.attributeType 
  - aws_account_id 
  - vendor_region 
  - user_agent 
 
  impact: 60
  confidence: 80
  # (impact * confidence)/100
  risk_score: 48
  context:
  - Source:Cloud Data
  - Scope:External
  - Outcome:Allowed
  - Stage:Execution
  - Stage:Exfiltration
  message: User $user$ has created an open/public bucket $bucketName$ with the following permissions $permission$
  observable:
  - name: userName
    type: User
    role:
    - Attacker
  - name: bucketName
    type: Other
    role:
    - Victim
  security_domain: threat