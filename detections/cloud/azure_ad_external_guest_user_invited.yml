name: Azure AD External Guest User Invited
id: c1fb4edb-cab1-4359-9b40-925ffd797fb5
version: 1
date: '2022-08-18'
author: Gowthamaraj Rajendran, Mauricio Velazco, Splunk
type: TTP
datamodel: []
description: The following analytic identifies the creation of a account for External Guest User through invitation.
  With Azure AD B2B collaboration, you can invite anyone to collaborate with your organization using their own work, school, or social account.
  Adversaries and red teams alike who have obtained administrative access may invite an External Guest User to establish Persistence and obtain single-factor access to an Azure AD environment.
search: '`azuread` "body.operationName"="Invite external user" 
  | rename body.properties.* as * 
  | rename targetResources{}.userPrincipalName as userPrincipalName 
  | rename initiatedBy.user.userPrincipalName as initiatedBy 
  | rename targetResources{}.type as type 
  | stats values(userPrincipalName) by _time, type, initiatedBy, result, body.operationName
  | `azure_ad_external_guest_user_invited_filter`'
how_to_implement: You must install the latest version of Splunk Add-on for Microsoft Cloud Services from Splunkbase(https://splunkbase.splunk.com/app/3110/#/details). You must be ingesting Azure Active Directory events into your Splunk environment. 
  Specifically, this analytic leverages the AuditLogs log category.
known_false_positives: Administrator may legitimately invite external guest users. Filter as needed.
references:
- https://dirkjanm.io/assets/raw/US-22-Mollema-Backdooring-and-hijacking-Azure-AD-accounts_final.pdf
- https://attack.mitre.org/techniques/T1136/003/
- https://docs.microsoft.com/en-us/azure/active-directory/external-identities/b2b-quickstart-add-guest-users-portal
tags:
  analytic_story:
  - Azure Active Directory Persistence
  asset_type: Azure Active Directory
  cis20:
  - CIS 3
  - CIS 5
  - CIS 16
  confidence: 90
  context:
  - Source:Cloud Data
  - Stage:Persistence
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1136.003/azure_ad_external_guest_user_invited/azure-audit.log
  impact: 50
  kill_chain_phases:
  - Exploitation
  message: External Guest User $userPrincipalName$ initiated by $initiatedBy$ 
  mitre_attack_id:
  - T1136.003
  nist:
  - DE.CM
  observable:
  - name: userPrincipalName
    type: User
    role:
    - Victim
  - name: initiatedBy
    type: User
    role:
    - Attacker
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - body.properties.targetResources{}.userPrincipalName
  - body.properties.targetResources{}.type
  - body.properties.initiatedBy.user.userPrincipalName
  - body.properties.result
  risk_score: 45
  security_domain: threat
