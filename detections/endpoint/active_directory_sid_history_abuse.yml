name: Active Directory SID History Abuse
id: 5fde0b7c-df7a-40b1-9b3a-294c00f0289d
version: 1
date: '2022-09-09'
author: Dean Luxton
type: TTP
datamodel: []
description: The SID history AD attribute allows users to inherit permissions from a separate AD account. Initially developed for access 
 continuity when migrating domains, the attribute can also be applied for two objects within the same domain. Enabling a stealthy way 
 for a user or computer object to be a member of a privileged group without any noisy group membership changes. This detection looks for 
 changes to user or computer objects with the addition of the SID History attribute - yes computer accounts too. 
 Working with SID Resolution enabled or disabled, written for XML-Wineventlog. 
search: '`wineventlog_security` (EventCode=4742 OR EventCode=4738) NOT SidHistory
  IN ("%%1793", -)
  | rex field=SidHistory "(^%{|^)(?P<SidHistoryMatch>.*)(\-|\\\)"
  | rex field=TargetSid "^(?P<TargetSidmatch>.*)(\-|\\\)"
  | where SidHistoryMatch=TargetSidmatch OR SidHistoryMatch=TargetDomainName
  | rename TargetSid as userSid
  | table _time action status host user userSid SidHistory Logon_ID src_user | `active_directory_sid_history_abuse_filter`'
how_to_implement: To successfully implement this search, you ned to be ingesting eventcodes
 `4738` and `4742`. The Advanced Security Audit policy settings 
 `Audit User Account Management` and  `Audit Computer Account Management`
 within `Account Management` need to be enabled.
known_false_positives: Unknown
references:
- https://adsecurity.org/?p=1772
tags:
  analytic_story:
  - Domain Controller Attacks
  - Windows Persistence Techniques
  asset_type: Endpoint
  cis20:
  - CIS 3
  - CIS 5
  - CIS 16
  confidence: 90
  context:
  - Source:AD
  - Stage:Persistence
  - Stage:Defense Evasion
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1134.005/mimikatz/windows-security-xml.log
  impact: 100
  kill_chain_phases:
  - Actions on Objectives
  message: Active Directory SID History Attribute was added to $user$ by $src_user$
  mitre_attack_id:
  - T1134.005
  - T1134
  nist:
  - DE.CM
  observable:
  - name: src_user
    type: User
    role:
    - Victim
  - name: user
    type: User
    role:
    - Victim
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - EventCode
  - SidHistory
  - TargetSid
  - TargetDomainName
  - user
  - src_user
  - Logon_ID
  risk_score: 90
  security_domain: endpoint
