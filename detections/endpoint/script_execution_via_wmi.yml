name: Script Execution via WMI
id: aa73f80d-d728-4077-b226-81ea0c8be589
version: 4
date: '2020-03-16'
author: Rico Valdez, Michael Haag, Splunk
type: batch
datamodel: []
description: 'This search looks for scripts launched via WMI. \

  1. It is located in the %windir%\System32\wbem directory. "wbem" stands for "Web-Based Enterprise Management" and this directory houses core components related to Windows Management Instrumentation (WMI), which is Microsoftâ€™s implementation of the WBEM standard \ 

  1. It has the following file description - WMI Standard Event Consumer - scripting. An event consumer is a WMI component that performs an action in response to a trigger. In the case of scrcons.exe, it executes Windows Script Host (WSH) code (i.e., JScript and VBScript) in response to some event occurring. More specifically, it is the code that implements the ActiveScriptEventConsumer WMI event class \
  
  1. Because WMI is implemented as DCOM, scrcons.exe is expected to launch as a child process of the DcomLaunch service (command line %windir%\system32\svchost.exe -k DcomLaunch -p), as was the case in this instance \ 
  
  1. It is expected to have the following command line: %windir%\System32\wbem\scrcons.exe -Embedding \ 
  
  1. The process is expected to execute as NT AUTHORITY\SYSTEM and any child processes of scrcons.exe are expected to execute with system privileges, which was also the case with dllhost.exe.'

search: '| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time)
  as lastTime from datamodel=Endpoint.Processes where Processes.process_name=scrcons.exe
  by Processes.dest Processes.user Processes.parent_process Processes.process_name
  Processes.process Processes.process_id Processes.parent_process_id
  | `drop_dm_object_name(Processes)` 
  | `security_content_ctime(firstTime)`
  | `security_content_ctime(lastTime)`
  | `script_execution_via_wmi_filter` '
how_to_implement: You must be ingesting endpoint data that tracks process activity,
  including parent-child relationships from your endpoints to populate the Endpoint
  data model in the Processes node. The command-line arguments are mapped to the "process"
  field in the Endpoint data model.
known_false_positives: Although unlikely, administrators may use wmi to launch scripts
  for legitimate purposes. Filter as needed.
references:
  - https://redcanary.com/blog/child-processes/
tags:
  analytic_story:
  - Suspicious WMI Use
  asset_type: Endpoint
  automated_detection_testing: passed
  cis20:
  - CIS 3
  - CIS 5
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1047/execution_scrcons/windows-sysmon.log
  kill_chain_phases:
  - Actions on Objectives
  mitre_attack_id:
  - T1047
  nist:
  - PR.PT
  - PR.AT
  - PR.AC
  - PR.IP
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - Processes.process_name
  - Processes.user
  - Processes.dest
  security_domain: endpoint
