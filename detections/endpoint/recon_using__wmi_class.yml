name: Recon Using  WMI Class
id: 018c1972-ca07-11eb-9473-acde48001122
version: 1
date: '2021-06-10'
author: Teoderick Contreras, Splunk
type: batch
datamodel:
- Endpoint
description: This search is to detect a powershell script that do a recon to the targetted
  or compromised machine. This technique is common nowadays to know the running process,
  services
search: '`powershell` EventCode=4104 | eval pwsh  = if(match(Message, "SELECT") OR
  match(Message, "Get-WmiObject"), 1, 0) | eval recon = if(match(Message, "Win32_Bios")
  OR match(Message,"Win32_OperatingSystem") OR match(Message,"Win32_Processor") OR
  match(Message,"Win32_ComputerSystem") OR match(Message,"Win32_ComputerSystemProduct")
  OR match(Message,"Win32_ShadowCopy"), 1,0) | addtotals fieldname=score pwsh, recon
  | where score = 2 | stats count min(_time) as firstTime max(_time) as lastTime by
  score EventCode Message ComputerName User | `security_content_ctime(firstTime)`
  | `security_content_ctime(lastTime)` | `recon_using__wmi_class_filter`'
how_to_implement: To successfully implement this search, you need to be ingesting
  logs with the powershell logs from your endpoints. make sure you enable needed registry
  to monitor this event.
known_false_positives: network administrator may used this command for checking purposes
references:
- https://news.sophos.com/en-us/2020/05/12/maze-ransomware-1-year-counting/
tags:
  analytic_story:
  - Malicious PowerShell
  kill_chain_phases:
  - Reconnaissance
  mitre_attack_id:
  - T1592
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - score
  - EventCode
  - Message
  - ComputerName
  - User
  security_domain: endpoint
  automated_detection_testing: passed
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/honeypots/pwsh/windows-powershell.log
