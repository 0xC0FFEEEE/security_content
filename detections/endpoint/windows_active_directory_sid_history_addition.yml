name: Windows Active Directory SID History Addition
id: 41bbb371-28ba-439c-bb5c-d9930c28365d
version: 1
date: '2022-11-17'
author: Dean Luxton
type: TTP
datamodel: []
description: The following analytic looks for changes to the sIDHistory AD attribute of user or computer objects. 
 The SID history AD attribute allows users to inherit permissions from a separate AD account without group changes. Initially developed for access
 continuity when migrating user accounts to different domains, this attribute can be abused for inter-domain privilege escalation and persistence. 
search: '`wineventlog_security` (EventCode=4742 OR EventCode=4738) (SidHistory!="%%1793"
  AND SidHistory!="-")

  | rename TargetSid as userSid

  | table _time action status host user userSid SidHistory Logon_ID src_user | `windows_active_directory_sid_history_addition_filter`'
how_to_implement: To successfully implement this search, you need to be ingesting eventcodes
 `4738` and `4742`. The Advanced Security Audit policy settings
 `Audit User Account Management` and  `Audit Computer Account Management`
 within `Account Management` all need to be enabled.
known_false_positives: Domain mergers and migrations may generate large volumes of false positives for this analytic. 
  Where this use case is not viable, please see the two auxillery use cases for same domain and privileged SID history additions. 
references:
- https://adsecurity.org/?p=1772
- https://learn.microsoft.com/en-us/windows/win32/adschema/a-sidhistory?redirectedfrom=MSDN
- https://learn.microsoft.com/en-us/defender-for-identity/security-assessment-unsecure-sid-history-attribute
tags:
  analytic_story:
  - Windows Domain Controller Attacks
  asset_type: Endpoint
  cis20:
  - CIS 4
  - CIS 6
  - CIS 16
  confidence: 80
  context:
  - Source:AD
  - Stage:Persistence
  - Stage:Defense Evasion
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1134.005/mimikatz/windows-security-xml.log
  impact: 100
  kill_chain_phases:
  - Actions on Objectives
  message: Active Directory SID History Attribute was added to $user$ by $src_user$
  mitre_attack_id:
  - T1134.005
  - T1134
  nist:
  - DE.CM
  observable:
  - name: src_user
    type: User
    role:
    - Victim
  - name: user
    type: User
    role:
    - Victim
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - EventCode
  - SidHistory
  - TargetSid
  - TargetDomainName
  - user
  - src_user
  - Logon_ID
  risk_score: 80
  security_domain: endpoint

