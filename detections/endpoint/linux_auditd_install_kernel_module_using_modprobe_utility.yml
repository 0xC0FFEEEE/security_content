name: Linux Auditd Install Kernel Module Using Modprobe Utility
id: 95165985-ace5-4d42-9c42-93a89a5af901
version: 1
date: '2024-08-09'
author: Teoderick Contreras, Splunk
status: production
type: Anomaly
description: The following analytic detects the installation of a Linux kernel module
  using the modprobe utility. It leverages data from Endpoint Detection and Response
  (EDR) agents, focusing on process names and command-line executions. This activity
  is significant because installing a kernel module can indicate an attempt to deploy
  a rootkit or other malicious kernel-level code, potentially leading to elevated
  privileges and bypassing security detections. If confirmed malicious, this could
  allow an attacker to gain persistent, high-level access to the system, compromising
  its integrity and security.
data_source:
- Linux Auditd Syscall
search: linux_auditd` type=SYSCALL comm=modprobe | stats count min(_time) as firstTime
  max(_time) as lastTime by comm exe  SYSCALL UID ppid pid success | `security_content_ctime(firstTime)`|
  `security_content_ctime(lastTime)`| `linux_auditd_install_kernel_module_using_modprobe_utility_filter`
how_to_implement: The detection is based on data that originates from Endpoint Detection
  and Response (EDR) agents. These agents are designed to provide security-related
  telemetry from the endpoints where the agent is installed. To implement this search,
  you must ingest logs that contain the process complete command-line executions.
  These logs must be processed using the appropriate Splunk Technology Add-ons that
  are specific to the EDR product. Use the Splunk Common Information Model (CIM) to
  normalize the field names and speed up the data modeling process.
known_false_positives: Administrator or network operator can execute this command.
  Please update the filter macros to remove false positives.
references:
- https://docs.fedoraproject.org/en-US/fedora/rawhide/system-administrators-guide/kernel-module-driver-configuration/Working_with_Kernel_Modules/
- https://security.stackexchange.com/questions/175953/how-to-load-a-malicious-lkm-at-startup
- https://0x00sec.org/t/kernel-rootkits-getting-your-hands-dirty/1485
tags:
  analytic_story:
  - Linux Privilege Escalation
  - Linux Persistence Techniques
  - Linux Rootkit
  asset_type: Endpoint
  confidence: 80
  impact: 80
  message: $comm$ was executed on host.
  mitre_attack_id:
  - T1547.006
  - T1547
  observable:
  - name: comm
    type: Other
    role:
    - Victim
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - comm
  - exe
  - SYSCALL
  - UID
  - ppid
  - pid
  risk_score: 64
  security_domain: endpoint
tests:
- name: True Positive Test
  attack_data:
  - data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1547.006/linux_auditd_modprobe/linux_auditd_modprobe.log
    source: /var/log/audit/audit.log
    sourcetype: linux:audit
