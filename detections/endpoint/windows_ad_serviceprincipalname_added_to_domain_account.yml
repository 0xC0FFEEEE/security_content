name: Windows AD ServicePrincipalName Added To Domain Account
id: 8a1259cb-0ea7-409c-8bfe-74bad89259f9
version: 1
date: '2022-11-17'
author: Mauricio Velazco, Splunk
type: TTP
datamodel: []
description: tbd
search: ' `wineventlog_security` EventCode=5136 AttributeLDAPDisplayName=servicePrincipalName OperationType="%%14674"
  | stats values(ObjectDN) by _time, Computer, SubjectUserName, AttributeValue
  | `windows_ad_serviceprincipalname_added_to_domain_account_filter`'
how_to_implement: To successfully implement this search, you ned to be ingesting Event codes 
 `5137` and `5141`. The Advanced Security Audit policy setting `Audit Directory Services Changes` 
 within `DS Access` needs to be enabled. For these event codes to be generated, specific SACLs are required.
known_false_positives: A Service Principal Name should only be added to an account when an application requires it. While infrequent, this detection may trigger on 
  legitimate actions. Filter as needed.
references:
- https://adsecurity.org/?p=3466
- https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting
- https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136
tags:
  analytic_story:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1098/service_principal_name_added/windows-security.log
  asset_type: endpoint
  cis20:
  - CIS 3
  - CIS 5
  - CIS 16
  confidence: 50
  context:
  - Source:Endpoint
  - Stage:Persistence
  dataset:
  - UPDATE_DATASET_URL
  impact: 60
  kill_chain_phases:
  - Installation
  - Actions on Objectives
  message: A Servince Principal Name for $ObjectDN$ was set by $SubjectUserName$
  mitre_attack_id:
  - T1098
  nist:
  - DE.CM
  observable:
  - name: SubjectUserName
    type: User
    role:
    - Attacker
  - name: ObjectDN
    type: User
    role:
    - Victim
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - EventCode
  - ObjectDN
  - signature
  - SubjectUserName
  - Computer
  risk_score: 30
  security_domain: endpoint
