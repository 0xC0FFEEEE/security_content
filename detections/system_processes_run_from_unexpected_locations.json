{
    "asset_type": "Endpoint",
    "baselines": [
        {
            "id": "b4d0dfb2-2195-4f6e-93a3-48468ed9734e",
            "name": "Monitor Successful Backups",
            "type": "splunk"
        },
        {
            "id": "b2178fed-592f-492b-b851-74161678aa56",
            "name": "Monitor Unsuccessful Backups",
            "type": "splunk"
        },
        {
            "id": "6a4dbd1b-4502-4a11-943a-82b5ae7a42d7",
            "name": "Windows Updates Install Failures",
            "type": "splunk"
        },
        {
            "id": "6a80535c-86a6-4b54-894c-4b446d0c701d",
            "name": "Windows Updates Install Successes",
            "type": "splunk"
        },
        {
            "id": "d2a4d85b-fc6a-47a0-82f6-bc1ec2ebc459",
            "name": "Baseline of Command Line Length - MLTK",
            "type": "splunk"
        },
        {
            "id": "df98763b-0b08-4281-8ef9-08db7ac572a9",
            "name": "Baseline of SMB Traffic - MLTK",
            "type": "splunk"
        },
        {
            "id": "fc0edc95-ff2b-48b0-9f6f-63da3789fd23",
            "name": "Previously seen command line arguments",
            "type": "splunk"
        },
        {
            "id": "d2a4d85b-fc6a-47a0-82f6-bc1ec2ebc459",
            "name": "Baseline of Command Line Length - MLTK",
            "type": "splunk"
        },
        {
            "id": "d2a4d85b-fc6a-47a0-82f6-bc1ec2ebc459",
            "name": "Baseline of Command Line Length - MLTK",
            "type": "splunk"
        }
    ],
    "confidence": "medium",
    "creation_date": "2016-08-24",
    "data_metadata": {
        "data_models": [
            "Endpoint"
        ],
        "data_source": [
            "Endpoint Intel"
        ],
        "providing_technologies": [
            "Carbon Black Response",
            "CrowdStrike Falcon",
            "Sysmon",
            "Tanium",
            "Ziften"
        ]
    },
    "description": "This search looks for system processes that normally run out of C:\\Windows\\System32\\ or C:\\Windows\\SysWOW64 that are not run from that location.  This can indicate a malicious process that is trying to hide as a legitimate process.",
    "detect": {
        "splunk": {
            "correlation_rule": [
                {
                    "notable": {
                        "nes_fields": "user, process_name, dest",
                        "rule_description": "The system $dest$ has a process that normally runs out of Windows\\System32\\ that is not being run from that location.",
                        "rule_title": "System Processes Run From Unexpected Location on $dest$"
                    },
                    "risk": {
                        "risk_object": "dest",
                        "risk_object_type": [
                            "system"
                        ],
                        "risk_score": 50
                    },
                    "suppress": {
                        "suppress_fields": "dest,process_name",
                        "suppress_period": "86400s"
                    }
                },
                {
                    "schedule": {
                        "cron_schedule": "0 * * * *",
                        "earliest_time": "-70m@m",
                        "latest_time": "-10m@m"
                    }
                },
                {
                    "search": "| tstats `summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.process_path !=\"C:\\\\Windows\\\\System32*\" Processes.process_path !=\"C:\\\\Windows\\\\SysWOW64*\" by Processes.user Processes.dest Processes.process_name Processes.process_path Processes.process_id | `drop_dm_object_name(\"Processes\")` | `ctime(firstTime)`| `ctime(lastTime)`| `isWindowsSystemFile`"
                }
            ]
        }
    },
    "eli5": "This search returns all the processes that are not executing out of the C:\\Windows\\System32 or C:\\Windows\\SysWOW64 directories. It then uses a regular expression to extract the file name of the running process. Next, it takes the filename and looks it up in a table of files that should normally run out of the C:\\Windows\\System32 or C:\\Windows\\SysWOW64 directory. Any matches are then returned.",
    "entities": [
        "dest"
    ],
    "how_to_implement": "To successfully implement this search you need to ingest details about process execution from your hosts. Specifically, this search requires the process name and the full path to the process executable.",
    "id": "a34aae96-ccf8-4aef-952c-3ea21444444d",
    "investigations": [
        {
            "id": "fdcfb369-1725-4c24-824a-22972d7f0d44",
            "name": "Get Backup Logs For Endpoint",
            "type": "splunk"
        },
        {
            "id": "d98675ed-da43-4a7e-96a7-eeca3232ba8e",
            "name": "Get Update Logs For Endpoint",
            "type": "splunk"
        },
        {
            "id": "df7a7f50-30f2-4cde-8448-69d2d5f9b3c5",
            "name": "Get Vulnerability Logs For Endpoint",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd76",
            "name": "Get Authentication Logs For Endpoint",
            "type": "splunk"
        },
        {
            "id": "3d6c3213-5fff-4a1e-b57d-b24c262171e7",
            "name": "Get Notable History",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd74",
            "name": "Get User Information from Identity Table",
            "type": "splunk"
        },
        {
            "id": "fdcfb369-1725-4c24-824a-22972d7f0d55",
            "name": "Get Risk Modifiers For User",
            "type": "splunk"
        },
        {
            "id": "fdcfb369-1725-4c24-824a-22972d7f0d65",
            "name": "Get Risk Modifiers For Endpoint",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd71",
            "name": "Get Process Info",
            "type": "splunk"
        },
        {
            "id": "9925d08f-561e-4faa-8912-e3888a842341",
            "name": "Get Process Information For Port Activity",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd22",
            "name": "Investigate Web Activity From Host",
            "type": "splunk"
        },
        {
            "id": "fecf2918-670d-4f1c-872b-3d7317a41bf9",
            "name": "Get Parent Process Info",
            "type": "splunk"
        },
        {
            "id": "f3fb4d1b-5f33-4b01-b541-c7af9534c242",
            "name": "Get Notable Info",
            "type": "splunk"
        },
        {
            "id": "3d6c3213-5fff-4a1e-b57d-b24c262171e7",
            "name": "Get Notable History",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd74",
            "name": "Get User Information from Identity Table",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd76",
            "name": "Get Authentication Logs For Endpoint",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd71",
            "name": "Get Process Info",
            "type": "splunk"
        },
        {
            "id": "fecf2918-670d-4f1c-872b-3d7317a41bf9",
            "name": "Get Parent Process Info",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd22",
            "name": "Investigate Web Activity From Host",
            "type": "splunk"
        },
        {
            "id": "3d6c3213-5fff-4a1e-b57d-b24c262171e7",
            "name": "Get Notable History",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd74",
            "name": "Get User Information from Identity Table",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd76",
            "name": "Get Authentication Logs For Endpoint",
            "type": "splunk"
        },
        {
            "id": "fdcfb369-1725-4c24-824a-22972d7f0d55",
            "name": "Get Risk Modifiers For User",
            "type": "splunk"
        },
        {
            "id": "fdcfb369-1725-4c24-824a-22972d7f0d65",
            "name": "Get Risk Modifiers For Endpoint",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd71",
            "name": "Get Process Info",
            "type": "splunk"
        },
        {
            "id": "bc91a8cf-35e7-4bb2-8140-e756cc06fd22",
            "name": "Investigate Web Activity From Host",
            "type": "splunk"
        }
    ],
    "known_false_positives": "None identified",
    "maintainers": [
        {
            "company": "Splunk",
            "email": "davidd@splunk.com",
            "name": "David Dorsey"
        }
    ],
    "mappings": {
        "cis20": [
            "CIS 8"
        ],
        "kill_chain_phases": [
            "Actions on Objectives"
        ],
        "mitre_attack": [
            "Defense Evasion",
            "Masquerading"
        ],
        "nist": [
            "PR.PT",
            "DE.CM"
        ]
    },
    "modification_date": "2019-02-28",
    "name": "System Processes Run From Unexpected Locations",
    "original_authors": [
        {
            "company": "Splunk",
            "email": "davidd@splunk.com",
            "name": "David Dorsey"
        }
    ],
    "references": [],
    "security_domain": "endpoint",
    "spec_version": 2,
    "type": "splunk",
    "version": "3.0"
}