---
title: "Detect Outbound SMB Traffic"
excerpt: "File Transfer Protocols"
categories:
  - Network
last_modified_at: 2020-07-21
toc: true
tags:
  - TTP
  - T1071.002
  - File Transfer Protocols
  - Command And Control
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  - Network_Traffic
  - Actions on Objectives
  - Command and Control
---

# Detect Outbound SMB Traffic

This search looks for outbound SMB connections made by hosts within your network to the Internet. SMB traffic is used for Windows file-sharing activity. One of the techniques often used by attackers involves retrieving the credential hash using an SMB request made to a compromised server controlled by the threat actor.

- **Product**: Splunk Enterprise, Splunk Enterprise Security, Splunk Cloud
- **Datamodel**:[Network_Traffic](https://docs.splunk.com/Documentation/CIM/latest/User/NetworkTraffic)
- **ATT&CK**: [T1071.002](https://attack.mitre.org/techniques/T1071/002/)
- **Last Updated**: 2020-07-21
- **Author**: Bhavin Patel, Stuart Hopkins from Splunk


#### ATT&CK

| ID          | Technique   | Tactic       |
| ----------- | ----------- |--------------|
| T1071.002 | File Transfer Protocols | Command And Control |


#### Search

```

| tstats `security_content_summariesonly` earliest(_time) as start_time latest(_time) as end_time values(All_Traffic.action) as action values(All_Traffic.app) as app values(All_Traffic.dest_ip) as dest_ip values(All_Traffic.dest_port) as dest_port values(sourcetype) as sourcetype count from datamodel=Network_Traffic where ((All_Traffic.dest_port=139 OR All_Traffic.dest_port=445 OR All_Traffic.app=&#34;smb&#34;) AND NOT (All_Traffic.action=&#34;blocked&#34; OR All_Traffic.dest_category=&#34;internal&#34; OR All_Traffic.dest_ip=10.0.0.0/8 OR All_Traffic.dest_ip=172.16.0.0/12 OR All_Traffic.dest_ip=192.168.0.0/16 OR All_Traffic.dest_ip=100.64.0.0/10)) by All_Traffic.src_ip 
| `drop_dm_object_name(&#34;All_Traffic&#34;)` 
| `security_content_ctime(start_time)` 
| `security_content_ctime(end_time)` 
| `detect_outbound_smb_traffic_filter`
```

#### Associated Analytic Story

* [Hidden Cobra Malware](_stories/hidden_cobra_malware)

* [DHS Report TA18-074A](_stories/dhs_report_ta18-074a)

* [NOBELIUM Group](_stories/nobelium_group)


#### How To Implement
In order to run this search effectively, we highly recommend that you leverage the Assets and Identity framework. It is important that you have good understanding of how your network segments are designed, and be able to distinguish internal from external address space. Add a category named `internal` to the CIDRs that host the companys assets in `assets_by_cidr.csv` lookup file, which is located in `$SPLUNK_HOME/etc/apps/SA-IdentityManagement/lookups/`. More information on updating this lookup can be found here: https://docs.splunk.com/Documentation/ES/5.0.0/Admin/Addassetandidentitydata. This search also requires you to be ingesting your network traffic and populating the Network_Traffic data model

#### Required field

* _time

* All_Traffic.action

* All_Traffic.app

* All_Traffic.dest_ip

* All_Traffic.dest_port

* sourcetype

* All_Traffic.dest_category

* All_Traffic.src_ip


#### Kill Chain Phase

* Actions on Objectives

* Command and Control


#### Known False Positives
It is likely that the outbound Server Message Block (SMB) traffic is legitimate, if the company&#39;s internal networks are not well-defined in the Assets and Identity Framework. Categorize the internal CIDR blocks as `internal` in the lookup file to avoid creating notable events for traffic destined to those CIDR blocks. Any other network connection that is going out to the Internet should be investigated and blocked. Best practices suggest preventing external communications of all SMB versions and related protocols at the network boundary.




#### Reference


#### Test Dataset
Replay any dataset to Splunk Enterprise by using our [`replay.py`](https://github.com/splunk/attack_data#using-replaypy) tool or the [UI](https://github.com/splunk/attack_data#using-ui).
Alternatively you can replay a dataset into a [Splunk Attack Range](https://github.com/splunk/attack_range#replay-dumps-into-attack-range-splunk-server)



_version_: 3

```
#############
# Automatically generated by doc_gen.py in https://github.com/splunk/security_content''
# On Date: 2021-09-17 11:18:22.006076 UTC''
# Author: Splunk Security Research''
# Contact: research@splunk.com''
#############
```